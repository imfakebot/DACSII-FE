<div class="dashboard-container">
  <header class="dashboard-header">
    <h1>Dashboard Quản Trị</h1>
    <p class="subtitle">Tổng quan hoạt động và doanh thu năm {{ revenueYear }}</p>
  </header>

  <!-- Branch Filter -->
  <section class="filters-section">
    <div class="filters-group">
      <div class="filter-item">
        <label for="branchFilter">Chi nhánh</label>
        <select id="branchFilter" [(ngModel)]="selectedBranchId" class="form-select">
          <option value="">-- Tất cả chi nhánh --</option>
          <option *ngFor="let branch of branches" [value]="branch.id">{{ branch.name }}</option>
        </select>
      </div>

      <div class="filter-actions">
        <button class="btn btn-primary" (click)="applyBranchFilter()">
          <i class="fa-solid fa-filter"></i> Lọc
        </button>
        <button class="btn btn-secondary" (click)="clearBranchFilter()">
          <i class="fa-solid fa-rotate-left"></i> Xóa bộ lọc
        </button>
      </div>
    </div>
  </section>

  <!-- Stats Overview Cards -->
  <section class="stats-grid">
    <!-- Revenue Card -->
    <div class="stat-card revenue-card">
      <div class="stat-icon">
        <i class="fa-solid fa-sack-dollar"></i>
      </div>
      <div class="stat-content">
        <p class="stat-label">Tổng Doanh Thu Năm {{ revenueYear }}</p>
        <h2 class="stat-value" *ngIf="!statsLoading && !revenueLoading">{{ formatCurrency(totalRevenue) }}</h2>
        <div class="stat-loading" *ngIf="statsLoading || revenueLoading">
          <i class="fa-solid fa-spinner fa-spin"></i>
        </div>
        <p class="stat-note">Tổng các tháng trong biểu đồ</p>
      </div>
    </div>

    <!-- Transactions Card -->
    <div class="stat-card transactions-card">
      <div class="stat-icon">
        <i class="fa-solid fa-receipt"></i>
      </div>
      <div class="stat-content">
        <p class="stat-label">Tổng Giao Dịch Năm {{ revenueYear }}</p>
        <h2 class="stat-value" *ngIf="!statsLoading">{{ totalTransactions }}</h2>
        <div class="stat-loading" *ngIf="statsLoading">
          <i class="fa-solid fa-spinner fa-spin"></i>
        </div>
        <div class="stat-breakdown">
          <span class="breakdown-item success" title="Hoàn thành">
            <i class="fa-solid fa-check-circle"></i> 
            <span class="breakdown-label">Hoàn thành:</span>
            {{ getTransactionCount('completed') }}
          </span>
          <span class="breakdown-item pending" title="Chờ xử lý">
            <i class="fa-solid fa-clock"></i> 
            <span class="breakdown-label">Chờ xử lý:</span>
            {{ getTransactionCount('pending') }}
          </span>
          <span class="breakdown-item failed" title="Thất bại">
            <i class="fa-solid fa-xmark-circle"></i> 
            <span class="breakdown-label">Thất bại:</span>
            {{ getTransactionCount('failed') }}
          </span>
        </div>
      </div>
    </div>
  </section>

  <!-- Revenue Chart -->
  <section class="chart-section">
    <div class="chart-card">
      <div class="chart-header">
        <div>
          <h3>Doanh Thu Theo Tháng</h3>
          <p class="chart-subtitle">Biểu đồ theo năm {{ revenueYear }}</p>
        </div>
        <div class="chart-controls">
          <button class="btn-year" (click)="changeYear(-1)">
            <i class="fa-solid fa-chevron-left"></i>
          </button>
          <span class="year-label">{{ revenueYear }}</span>
          <button class="btn-year" (click)="changeYear(1)" [disabled]="revenueYear >= currentYear">
            <i class="fa-solid fa-chevron-right"></i>
          </button>
        </div>
      </div>

      <div class="chart-content" *ngIf="!revenueLoading">
        <svg [attr.width]="chartWidth" [attr.height]="chartHeight" class="revenue-chart">
          <!-- Grid lines -->
          <g class="grid">
            <line 
              *ngFor="let i of [0, 0.25, 0.5, 0.75, 1]"
              [attr.x1]="chartPadding.left"
              [attr.x2]="chartWidth - chartPadding.right"
              [attr.y1]="chartPadding.top + (chartHeight - chartPadding.top - chartPadding.bottom) * i"
              [attr.y2]="chartPadding.top + (chartHeight - chartPadding.top - chartPadding.bottom) * i"
              class="grid-line"
            />
          </g>

          <!-- Bars -->
          <g class="bars">
            <rect
              *ngFor="let bar of getBarChartData()"
              [attr.x]="bar.x"
              [attr.y]="bar.y"
              [attr.width]="bar.width"
              [attr.height]="bar.height"
              class="bar"
              [attr.data-value]="formatCompactCurrency(bar.value)"
            >
              <title>{{ bar.label }}: {{ formatCurrency(bar.value) }}</title>
            </rect>
          </g>

          <!-- Labels (Months) -->
          <g class="labels">
            <text
              *ngFor="let bar of getBarChartData()"
              [attr.x]="bar.labelX"
              [attr.y]="bar.labelY"
              class="month-label"
              text-anchor="middle"
            >
              {{ bar.label }}
            </text>
          </g>

          <!-- Value labels on bars -->
          <g class="value-labels">
            <text
              *ngFor="let bar of getBarChartData()"
              [attr.x]="bar.x + bar.width / 2"
              [attr.y]="bar.y - 5"
              class="value-label"
              text-anchor="middle"
            >
              {{ formatCompactCurrency(bar.value) }}
            </text>
          </g>
        </svg>
      </div>

      <div class="chart-loading" *ngIf="revenueLoading">
        <i class="fa-solid fa-spinner fa-spin"></i>
        <p>Đang tải dữ liệu...</p>
      </div>

      <div class="chart-error" *ngIf="revenueError">
        <i class="fa-solid fa-triangle-exclamation"></i>
        <p>{{ revenueError }}</p>
        <button class="btn-retry" (click)="loadRevenueChart()">Thử lại</button>
      </div>
    </div>
  </section>

  <!-- Recent Bookings -->
  <section class="bookings-section">
    <div class="bookings-card">
      <div class="bookings-header">
        <h3>Đơn Hàng Mới Nhất</h3>
        <a routerLink="/admin/bookings" class="view-all-link">
          Xem tất cả <i class="fa-solid fa-arrow-right"></i>
        </a>
      </div>

      <div class="bookings-list" *ngIf="!bookingsLoading">
        <div class="booking-item" *ngFor="let booking of recentBookings">
          <div class="booking-info">
            <div class="booking-header-row">
              <div class="booking-code">
                <i class="fa-solid fa-hashtag"></i>
                <span class="code-text">{{ booking.code }}</span>
              </div>
              <span class="booking-status" [ngClass]="getStatusClass(booking.status)">
                {{ getStatusLabel(booking.status) }}
              </span>
            </div>
            <div class="booking-customer">
              <i class="fa-solid fa-user"></i>
              <div class="customer-details">
                <span class="customer-name">{{ booking.customerName }}</span>
                <span class="customer-email" *ngIf="booking.customerEmail">{{ booking.customerEmail }}</span>
              </div>
            </div>
            <div class="booking-field">
              <i class="fa-solid fa-futbol"></i>
              <div class="field-details">
                <span class="field-name">{{ booking.fieldName }}</span>
                <span class="branch-name" *ngIf="booking.branchName">{{ booking.branchName }}</span>
              </div>
            </div>
            <div class="booking-time">
              <i class="fa-solid fa-clock"></i>
              <span>{{ formatDateTime(booking.startTime) }}</span>
              <span class="duration" *ngIf="booking.duration > 0">{{ booking.duration }} phút</span>
            </div>
          </div>
          <div class="booking-meta">
            <div class="booking-amount">{{ formatCurrency(booking.totalAmount) }}</div>
          </div>
        </div>

        <div class="no-bookings" *ngIf="recentBookings.length === 0">
          <i class="fa-solid fa-inbox"></i>
          <p>Chưa có đơn hàng nào</p>
        </div>
      </div>

      <div class="bookings-loading" *ngIf="bookingsLoading">
        <i class="fa-solid fa-spinner fa-spin"></i>
        <p>Đang tải...</p>
      </div>

      <div class="bookings-error" *ngIf="bookingsError">
        <i class="fa-solid fa-triangle-exclamation"></i>
        <p>{{ bookingsError }}</p>
      </div>
    </div>
  </section>
</div>
