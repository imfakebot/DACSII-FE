<div class="detail-page" *ngIf="field; else loading">
  <section class="hero" [style.background-image]="'url(' + ((field.images && field.images.length>0) ? field.images[0] : 'https://images.unsplash.com/photo-1521412644187-c49fa049e84d?w=1200&auto=format&fit=crop&q=60') + ')'">
    <div class="hero-overlay">
      <button class="ghost-btn" (click)="goBack()">
        <span aria-hidden="true">&#8592;</span>
        Trở lại danh sách
      </button>
      <div class="hero-content">
        <div class="pill-row">
          <span class="pill">
            <i class="fa-solid fa-tag"></i>
            {{ field.fieldType || field.type || 'Sân thể thao' }}
          </span>
          <span class="pill" *ngIf="field.ownerName">
            <i class="fa-solid fa-user"></i>
            {{ field.ownerName }}
          </span>
        </div>
        <h1>{{ field.name }}</h1>
        <p class="location">
          <i class="fa-solid fa-location-dot"></i>
          {{ (field.street || field.ward || field.city) ? ((field.street ? field.street + ', ' : '') + (field.ward ? field.ward + ', ' : '') + (field.city || '')) : 'Chưa cập nhật địa chỉ' }}
        </p>
        <div class="stats">
          <div class="stat">
            <span class="label">Đánh giá</span>
            <strong>
              <i class="fa-solid fa-star"></i>
              {{ field.avgRating ? (field.avgRating | number:'1.1-1') : 'Chưa có' }}
            </strong>
          </div>
          <div class="stat">
            <span class="label">Giá chuẩn</span>
            <strong>{{ field.pricePerHour ? (field.pricePerHour | currency:'VND':'symbol':'1.0-0') : 'Liên hệ' }}</strong>
          </div>
          <div class="stat">
            <span class="label">Sẵn sàng</span>
            <strong>{{ pricing?.available ? 'Có thể đặt' : 'Kiểm tra ngay' }}</strong>
          </div>
        </div>
      </div>
    </div>
  </section>

  <section class="content-grid">
    <article class="info-card">
      <header>
        <div>
          <p class="eyebrow">Thông tin sân</p>
          <h2>Trải nghiệm tốt nhất cho trận đấu của bạn</h2>
        </div>
        <!-- <button class="primary-outline" (click)="book(field.id)">Đặt ngay</button> -->
      </header>
      <p class="desc">{{ field.description || 'Sân có mặt cỏ chất lượng, hệ thống chiếu sáng hiện đại và phòng thay đồ sạch sẽ.' }}</p>

      <div class="info-grid">
        <div class="info-item">
          <span class="label">Loại sân</span>
          <p>{{ field.fieldType || field.type || 'Đang cập nhật' }}</p>
        </div>
        <div class="info-item">
          <span class="label">Giá tham khảo</span>
          <p>{{ field.pricePerHour ? (field.pricePerHour | currency:'VND':'symbol':'1.0-0') + '/giờ' : 'Liên hệ quản lý' }}</p>
        </div>
        <div class="info-item">
          <span class="label">Liên hệ</span>
          <p>{{ field.branchPhone || field.managerName || 'Đang cập nhật' }}</p>
        </div>
        <div class="info-item">
          <span class="label">Địa chỉ</span>
          <p>{{ (field.street || field.ward || field.city) ? ((field.street ? field.street + ', ' : '') + (field.ward ? field.ward + ', ' : '') + (field.city || '')) : 'Chưa cập nhật địa chỉ' }}</p>
        </div>
      </div>

      <div class="highlights">
        <span class="chip" *ngFor="let utility of field.utilities">
          <i class="fa-solid fa-circle-check"></i> {{ utility.name }}
          <span *ngIf="utility.price" class="text-xs text-gray-600">({{ utility.price | currency:'VND':'symbol':'1.0-0' }})</span>
        </span>
        <span class="chip" *ngIf="!field.utilities || field.utilities.length === 0">
          <i class="fa-solid fa-info-circle"></i> Chưa có tiện ích
        </span>
      </div>
    </article>

    <aside class="booking-card">
      <div class="card-header">
        <p class="eyebrow">Đặt lịch ngay</p>
        <h3>Tùy chỉnh khung giờ của bạn</h3>
      </div>
      <div class="form-grid">
        <label>
          <span>Ngày</span>
          <input type="date" [(ngModel)]="date" (change)="onDateChange()" class="form-input" />
        </label>
        <label class="time-parts">
          <span>Giờ bắt đầu</span>
          <div class="time-selects flex gap-2">
            <select [(ngModel)]="timeHour" (change)="onTimePartChange()" aria-label="Giờ" class="form-select flex-1">
              <option [ngValue]="null">Giờ</option>
              <option *ngFor="let h of hours" [ngValue]="h">{{ (h+'').padStart(2,'0') }}</option>
            </select>
            <span class="self-center">:</span>
            <select [(ngModel)]="timeMinute" (change)="onTimePartChange()" aria-label="Phút" class="form-select flex-1">
              <option [ngValue]="null">Phút</option>
              <option value="00">00</option>
              <option value="30">30</option>
            </select>
          </div>
        </label>
        <label>
          <span>Thời lượng (phút)</span>
          <select [(ngModel)]="duration" (change)="checkAvailability()" class="form-select">
            <option [ngValue]="null">Chọn thời lượng</option>
            <option [ngValue]="60">60 phút</option>
            <option [ngValue]="90">90 phút</option>
            <option [ngValue]="120">120 phút</option>
          </select>
        </label>
        <label>
          <span>Mã giảm giá (nếu có)</span>
          <input type="text" [(ngModel)]="voucherCode" placeholder="Nhập mã voucher" class="form-input" />
        </label>
      </div>

      <!-- Schedule Grid -->
      <div *ngIf="date && slots && slots.length > 0" class="schedule-grid mt-4">
        <div class="schedule-header">
          <h4 class="text-sm font-semibold text-gray-700">Lịch sân ngày {{ date }}</h4>
          <div class="legend">
            <span class="legend-item"><span class="dot available"></span> Trống</span>
            <span class="legend-item"><span class="dot selected"></span> Chọn</span>
            <span class="legend-item"><span class="dot booked"></span> Đã đặt</span>
          </div>
        </div>
        <div class="slots-container">
          <div 
            *ngFor="let slot of slots" 
            class="slot-item"
            [class.available]="slot.available && !slot.selected"
            [class.selected]="slot.selected"
            [class.booked]="!slot.available"
            (click)="onSlotClick(slot)">
            {{ slot.timeLabel }}
          </div>
        </div>
        <p *ngIf="scheduleLoading" class="text-xs text-gray-500 mt-2 text-center">
          <i class="fa-solid fa-spinner fa-spin mr-1"></i> Đang tải lịch...
        </p>
      </div>

      <div *ngIf="pricing" class="pricing-summary mt-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
        <div class="flex justify-between mb-2">
          <span>Đơn giá:</span>
          <span class="font-medium">{{ pricing.pricing.price_per_hour | currency:'VND':'symbol':'1.0-0' }}/giờ</span>
        </div>
        <div class="flex justify-between text-lg font-bold text-primary">
          <span>Tổng cộng:</span>
          <span>{{ pricing.pricing.total_price | currency:'VND':'symbol':'1.0-0' }}</span>
        </div>
      </div>

      <div *ngIf="bookingError" class="error-message mt-4 p-3 bg-red-50 text-red-600 rounded-md text-sm">
        <i class="fa-solid fa-circle-exclamation mr-2"></i> {{ bookingError }}
      </div>

      <div *ngIf="bookingMessage" class="success-message mt-4 p-3 bg-green-50 text-green-600 rounded-md text-sm">
        <i class="fa-solid fa-check-circle mr-2"></i> {{ bookingMessage }}
      </div>

      <div class="actions mt-6">
        <button 
          class="primary-btn w-full py-3 text-lg font-semibold shadow-lg hover:shadow-xl transition-all disabled:opacity-50 disabled:cursor-not-allowed"
          (click)="submitBooking()"
          [disabled]="creatingBooking || !date || !time || !duration">
          <span *ngIf="creatingBooking"><i class="fa-solid fa-spinner fa-spin mr-2"></i>Đang xử lý...</span>
          <span *ngIf="!creatingBooking">Thanh toán ngay</span>
        </button>
        <p *ngIf="!isLoggedIn" class="text-center text-sm text-gray-500 mt-2">
          Vui lòng <a routerLink="/login" class="text-primary hover:underline">đăng nhập</a> để đặt sân.
        </p>
      </div>
    </aside>
  </section>

  <!-- Reviews Section -->
  <section class="reviews-section" *ngIf="field">
    <app-field-reviews [fieldId]="field.id"></app-field-reviews>
  </section>
</div>

<!-- Modal removed: Using direct booking flow now -->

<ng-template #loading>
  <div class="detail-loading">
    <span class="loader"></span>
    Đang tải chi tiết sân...
  </div>
</ng-template>
