<div class="detail-page" *ngIf="field; else loading">
  <section class="hero" [style.background-image]="'url(' + ((field.images && field.images.length>0) ? field.images[0] : 'https://images.unsplash.com/photo-1521412644187-c49fa049e84d?w=1200&auto=format&fit=crop&q=60') + ')'">
    <div class="hero-overlay">
      <button class="ghost-btn" (click)="goBack()">
        <span aria-hidden="true">&#8592;</span>
        Trở lại danh sách
      </button>
      <div class="hero-content">
        <div class="pill-row">
          <span class="pill">
            <i class="fa-solid fa-tag"></i>
            {{ field.fieldType || field.type || 'Sân thể thao' }}
          </span>
          <span class="pill" *ngIf="field.ownerName">
            <i class="fa-solid fa-user"></i>
            {{ field.ownerName }}
          </span>
        </div>
        <h1>{{ field.name }}</h1>
        <p class="location">
          <i class="fa-solid fa-location-dot"></i>
          {{ (field.street || field.ward || field.city) ? ((field.street ? field.street + ', ' : '') + (field.ward ? field.ward + ', ' : '') + (field.city || '')) : 'Chưa cập nhật địa chỉ' }}
        </p>
        <div class="stats">
          <div class="stat">
            <span class="label">Đánh giá</span>
            <strong>
              <i class="fa-solid fa-star"></i>
              {{ field.avgRating ? (field.avgRating | number:'1.1-1') : 'Chưa có' }}
            </strong>
          </div>
          <div class="stat">
            <span class="label">Giá chuẩn</span>
            <strong>{{ field.pricePerHour ? (field.pricePerHour | currency:'VND':'symbol':'1.0-0') : 'Liên hệ' }}</strong>
          </div>
          <div class="stat">
            <span class="label">Sẵn sàng</span>
            <strong>{{ pricing?.available ? 'Có thể đặt' : 'Kiểm tra ngay' }}</strong>
          </div>
        </div>
      </div>
    </div>
  </section>

  <section class="content-grid">
    <article class="info-card">
      <header>
        <div>
          <p class="eyebrow">Thông tin sân</p>
          <h2>Trải nghiệm tốt nhất cho trận đấu của bạn</h2>
        </div>
        <!-- <button class="primary-outline" (click)="book(field.id)">Đặt ngay</button> -->
      </header>
      <p class="desc">{{ field.description || 'Sân có mặt cỏ chất lượng, hệ thống chiếu sáng hiện đại và phòng thay đồ sạch sẽ.' }}</p>

      <div class="info-grid">
        <div class="info-item">
          <span class="label">Loại sân</span>
          <p>{{ field.fieldType || field.type || 'Đang cập nhật' }}</p>
        </div>
        <div class="info-item">
          <span class="label">Giá tham khảo</span>
          <p>{{ field.pricePerHour ? (field.pricePerHour | currency:'VND':'symbol':'1.0-0') + '/giờ' : 'Liên hệ quản lý' }}</p>
        </div>
        <div class="info-item">
          <span class="label">Liên hệ</span>
          <p>{{ field.branchPhone || field.managerName || 'Đang cập nhật' }}</p>
        </div>
        <div class="info-item">
          <span class="label">Địa chỉ</span>
          <p>{{ (field.street || field.ward || field.city) ? ((field.street ? field.street + ', ' : '') + (field.ward ? field.ward + ', ' : '') + (field.city || '')) : 'Chưa cập nhật địa chỉ' }}</p>
          <button 
            type="button" 
            class="directions-btn" 
            (click)="getDirections()"
            title="Chỉ đường đến sân">
            <i class="fa-solid fa-location-arrow"></i>
            Chỉ đường
          </button>
        </div>
      </div>

      <div class="highlights">
        <span class="chip" *ngFor="let utility of field.utilities">
          <i class="fa-solid fa-circle-check"></i> {{ utility.name }}
          <span *ngIf="utility.price" class="text-xs text-gray-600">({{ utility.price | currency:'VND':'symbol':'1.0-0' }})</span>
        </span>
        <span class="chip" *ngIf="!field.utilities || field.utilities.length === 0">
          <i class="fa-solid fa-info-circle"></i> Chưa có tiện ích
        </span>
      </div>
    </article>

    <aside class="booking-card">
      <div class="card-header">
        <p class="eyebrow">Đặt lịch ngay</p>
        <h3>Tùy chỉnh khung giờ của bạn</h3>
      </div>
      <div class="form-grid">
        <label>
          <span>Ngày</span>
          <input type="date" [(ngModel)]="date" (change)="onDateChange()" class="form-input" />
        </label>
        <label class="time-parts">
          <span>Giờ bắt đầu</span>
          <div class="time-selects flex gap-2">
            <select [(ngModel)]="timeHour" (change)="onTimePartChange()" aria-label="Giờ" class="form-select flex-1">
              <option [ngValue]="null">Giờ</option>
              <option *ngFor="let h of hours" [ngValue]="h">{{ (h+'').padStart(2,'0') }}</option>
            </select>
            <span class="self-center">:</span>
            <select [(ngModel)]="timeMinute" (change)="onTimePartChange()" aria-label="Phút" class="form-select flex-1">
              <option [ngValue]="null">Phút</option>
              <option value="00">00</option>
              <option value="30">30</option>
            </select>
          </div>
        </label>
        <label>
          <span>Thời lượng (phút)</span>
          <select [(ngModel)]="duration" (change)="onScheduleChange()" class="form-select">
            <option [ngValue]="null">Chọn thời lượng</option>
            <option [ngValue]="60">60 phút</option>
            <option [ngValue]="90">90 phút</option>
            <option [ngValue]="120">120 phút</option>
          </select>
        </label>
        
        <!-- Voucher Selection -->
        <div class="voucher-selector">
          <label>
            <span>Ưu đãi</span>
            <button 
              type="button" 
              class="voucher-btn" 
              (click)="openVoucherModal()">
              <i class="fa-solid fa-ticket"></i>
              <span *ngIf="!selectedVoucher">Chọn ưu đãi</span>
              <span *ngIf="selectedVoucher" class="selected-voucher">
                {{ selectedVoucher.code }}
                <i class="fa-solid fa-times-circle" (click)="removeVoucher(); $event.stopPropagation()"></i>
              </span>
            </button>
          </label>
        </div>
      </div>

      <!-- Schedule Grid -->
      <div *ngIf="date && slots && slots.length > 0" class="schedule-area mt-4">
        <div class="schedule-header">
          <div class="schedule-title">
            <h4>
              Lịch sân ngày {{ date }}
              <!-- <span class="live-badge">
                <i class="fa-solid fa-circle"></i>
                LIVE
              </span> -->
            </h4>
            <span class="last-update" *ngIf="lastScheduleUpdate">
              Cập nhật {{ lastScheduleUpdate | date:'HH:mm:ss' }}
            </span>
          </div>
          <div class="legend">
            <span class="legend-item"><span class="dot available"></span> Trống</span>
            <span class="legend-item"><span class="dot selected"></span> Đã chọn</span>
            <span class="legend-item"><span class="dot booked"></span> Đã đặt</span>
          </div>
        </div>
        <div class="schedule-grid">
          <div 
            *ngFor="let slot of slots" 
            class="slot"
            [class.available]="slot.available"
            [class.selected]="slot.selected"
            [class.booked]="!slot.available"
            (click)="onSlotClick(slot)">
            {{ slot.timeLabel }}
          </div>
        </div>
        <p *ngIf="scheduleLoading" class="schedule-loading">
          <i class="fa-solid fa-spinner fa-spin"></i> Đang cập nhật lịch...
        </p>
      </div>

      <div *ngIf="pricingError" class="error-message mt-4 p-3 bg-red-50 text-red-600 rounded-md text-sm">
        <i class="fa-solid fa-circle-exclamation mr-2"></i> {{ pricingError }}
      </div>

      <div *ngIf="pricing as p" class="pricing-summary mt-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
        <h4 class="mb-2">Chi tiết giá</h4>
        <table class="w-full text-sm">
          <tbody>
            <tr>
              <td>Ngày</td>
              <td class="text-right">{{ p.booking_details.date }}</td>
            </tr>
            <tr>
              <td>Giờ bắt đầu</td>
              <td class="text-right">{{ p.booking_details.start_time }}</td>
            </tr>
            <tr>
              <td>Giờ kết thúc</td>
              <td class="text-right">{{ p.booking_details.end_time }}</td>
            </tr>
            <tr>
              <td>Đơn giá</td>
              <td class="text-right">{{ p.pricing.price_per_hour | currency:'VND':'symbol':'1.0-0' }}/giờ</td>
            </tr>
            <tr>
              <td>Thời lượng</td>
              <td class="text-right">{{ p.booking_details.duration }}</td>
            </tr>
            <tr *ngIf="p.pricing.original_price !== undefined">
              <td>Giá gốc</td>
              <td class="text-right line-through">{{ p.pricing.original_price | currency:'VND':'symbol':'1.0-0' }}</td>
            </tr>
            <tr *ngIf="p.pricing.discount">
              <td>Giảm giá</td>
              <td class="text-right text-green-600">-{{ p.pricing.discount | currency:'VND':'symbol':'1.0-0' }}</td>
            </tr>
            <tr class="font-bold">
              <td>Tổng phải trả</td>
              <td class="text-right">{{ p.pricing.total_price | currency:'VND':'symbol':'1.0-0' }}</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div *ngIf="bookingError" class="error-message mt-4 p-3 bg-red-50 text-red-600 rounded-md text-sm">
        <i class="fa-solid fa-circle-exclamation mr-2"></i> {{ bookingError }}
      </div>

      <div *ngIf="bookingMessage" class="success-message mt-4 p-3 bg-green-50 text-green-600 rounded-md text-sm">
        <i class="fa-solid fa-check-circle mr-2"></i> {{ bookingMessage }}
      </div>

      <!-- Voucher Display -->
      <div *ngIf="selectedVoucher" class="voucher-applied mt-4 p-3 bg-gradient-to-r from-purple-50 to-pink-50 border border-purple-200 rounded-md">
        <div class="flex justify-between items-center">
          <div class="flex items-center">
            <i class="fa-solid fa-ticket text-purple-600 mr-2"></i>
            <span class="font-semibold text-purple-700">{{ selectedVoucher.code }}</span>
            <span class="ml-2 text-sm text-gray-600">
              -{{ selectedVoucher.discountPercentage ? (selectedVoucher.discountPercentage + '%') : ((selectedVoucher.discountAmount || 0) | currency:'VND':'symbol':'1.0-0') }}
            </span>
          </div>
          <button 
            type="button"
            (click)="removeVoucher()"
            class="text-red-500 hover:text-red-700 transition-colors">
            <i class="fa-solid fa-times"></i>
          </button>
        </div>
        <div *ngIf="pricing && pricing.pricing.discount" class="text-xs text-green-600 mt-1">
          Tiết kiệm {{ pricing.pricing.discount | currency:'VND':'symbol':'1.0-0' }}
        </div>
      </div>

      <div class="actions mt-6">
        <button 
          class="pay-btn"
          (click)="submitBooking()"
          [disabled]="creatingBooking || !date || !time || !duration">
          <span *ngIf="creatingBooking">
            <i class="fa-solid fa-spinner fa-spin"></i>
            Đang xử lý...
          </span>
          <ng-container *ngIf="!creatingBooking">
            <i class="fa-solid fa-credit-card"></i>
            <span *ngIf="estimatedTotal !== null">
              Thanh toán {{ estimatedTotal | currency:'VND':'symbol':'1.0-0' }}
            </span>
            <span *ngIf="estimatedTotal === null">Chọn giờ và thời lượng để xem giá</span>
          </ng-container>
        </button>
        <p *ngIf="!isLoggedIn" class="text-center text-sm text-gray-500 mt-2">
          Vui lòng <a [routerLink]="['/Login/login']" class="text-primary hover:underline">đăng nhập</a> để đặt sân.
        </p>
      </div>
    </aside>
  </section>

  <!-- Voucher Modal -->
  <div class="voucher-modal-overlay" *ngIf="showVoucherModal" (click)="closeVoucherModal()">
    <div class="voucher-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Chọn ưu đãi</h3>
        <button class="close-btn" (click)="closeVoucherModal()">
          <i class="fa-solid fa-times"></i>
        </button>
      </div>
      
      <div class="modal-body">
        <div *ngIf="loadingVouchers" class="loading-state">
          <i class="fa-solid fa-spinner fa-spin"></i>
          Đang tải ưu đãi...
        </div>

        <div *ngIf="!loadingVouchers && availableVouchers.length === 0" class="empty-state">
          <i class="fa-solid fa-ticket-simple"></i>
          <p>Không có ưu đãi khả dụng</p>
        </div>

        <div class="vouchers-grid" *ngIf="!loadingVouchers && availableVouchers.length > 0">
          <div 
            class="voucher-card" 
            *ngFor="let voucher of availableVouchers"
            [class.selected]="selectedVoucher?.id === voucher.id"
            [class.disabled]="selectedVoucher?.id === voucher.id">
            <div class="voucher-header">
              <span class="voucher-code">{{ voucher.code }}</span>
              <span class="voucher-badge" *ngIf="voucher.discountPercentage">
                -{{ voucher.discountPercentage }}%
              </span>
              <span class="voucher-badge" *ngIf="voucher.discountAmount">
                -{{ voucher.discountAmount | number:'1.0-0' }}đ
              </span>
            </div>
            <p class="voucher-desc">
              <span *ngIf="voucher.discountPercentage">
                Giảm {{ voucher.discountPercentage }}% 
                <span *ngIf="voucher.maxDiscountAmount">(tối đa {{ voucher.maxDiscountAmount | number:'1.0-0' }}đ)</span>
              </span>
              <span *ngIf="voucher.discountAmount">
                Giảm {{ voucher.discountAmount | number:'1.0-0' }}đ
              </span>
              <span *ngIf="voucher.minOrderValue > 0">
                - Đơn tối thiểu {{ voucher.minOrderValue | number:'1.0-0' }}đ
              </span>
            </p>
            <div class="voucher-footer">
              <span class="voucher-expire">HSD: {{ voucher.validTo | date:'dd/MM/yyyy' }}</span>
              <button class="apply-btn" (click)="applyVoucher(voucher)" [disabled]="selectedVoucher?.id === voucher.id">
                <i class="fa-solid fa-check"></i>
                <span *ngIf="selectedVoucher?.id === voucher.id">Đã áp dụng</span>
                <span *ngIf="selectedVoucher?.id !== voucher.id">Áp dụng</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Reviews Section -->
  <section class="reviews-section" *ngIf="field">
    <app-field-reviews [fieldId]="field.id"></app-field-reviews>
  </section>
</div>

<!-- Modal removed: Using direct booking flow now -->

<ng-template #loading>
  <div class="detail-loading">
    <span class="loader"></span>
    Đang tải chi tiết sân...
  </div>
</ng-template>
