<div class="admin-field-form">
  <header class="page-header">
    <h1>{{ id ? 'Chỉnh sửa sân' : 'Tạo sân mới' }}</h1>
  </header>

  <section class="card">
    <div class="card__header">
      <h3>{{ id ? 'Chỉnh sửa sân' : 'Tạo sân mới' }}</h3>
    </div>
    <div class="card__body">
      <form *ngIf="!loading" (ngSubmit)="onSave()" class="create-form" autocomplete="off">
        <div class="form-grid">
          <label>
            <span class="label">Tên sân</span>
            <input name="name" [(ngModel)]="model.name" required />
          </label>

          <label>
            <span class="label">Loại sân *</span>
            <select name="fieldTypeId" [(ngModel)]="model.fieldTypeId" required>
              <option value="">(Chọn loại sân)</option>
              <option *ngFor="let ft of fieldTypes" [value]="ft.id">{{ ft.name }}</option>
            </select>
          </label>

          <label>
            <span class="label">Trạng thái *</span>
            <select name="status" [(ngModel)]="model.status" required>
              <option *ngFor="let opt of statusOptions" [value]="opt.value">{{ opt.label }}</option>
            </select>
          </label>

          <label class="full-width">
            <span class="label">Mô tả</span>
            <textarea name="description" [(ngModel)]="model.description"></textarea>
          </label>

          <label class="full-width">
            <span class="label">Hình ảnh</span>
            <input type="file" (change)="onFiles($event.target.files)" multiple accept="image/*" />
          </label>

          <label class="full-width">
            <span class="label">Tiện ích có sẵn tại sân</span>
            <ng-container *ngIf="utilitiesLoading">Đang tải tiện ích...</ng-container>
            <ng-container *ngIf="!utilitiesLoading && utilities && utilities.length > 0">
              <div class="utilities-grid">
                <label *ngFor="let utility of utilities" class="utility-checkbox">
                  <input 
                    type="checkbox" 
                    [checked]="isUtilitySelected(utility.id)"
                    (change)="toggleUtility(utility.id)"
                  />
                  <span class="utility-label">
                    {{ utility.name }}
                    <span *ngIf="utility.price" class="utility-price">({{ utility.price | number:'1.0-0' }}đ)</span>
                  </span>
                </label>
              </div>
            </ng-container>
            <div *ngIf="!utilitiesLoading && (!utilities || utilities.length === 0)" class="hint">
              Không có tiện ích nào trong hệ thống.
            </div>
          </label>

          <label class="full-width">
            <span class="label">Chi nhánh (Branch) <span *ngIf="isAdmin" style="color: red;">*</span></span>
            <ng-container *ngIf="branchesLoading">Đang tải chi nhánh...</ng-container>
            <ng-container *ngIf="!branchesLoading">
              <ng-container *ngIf="branches?.length; else noBranches">
                <select name="branchId" [(ngModel)]="model.branchId" [required]="isAdmin">
                  <option value="">(Chọn chi nhánh)</option>
                  <option *ngFor="let b of branches" [value]="b.id">{{ b.name }}</option>
                </select>
                <div class="hint" style="font-size: 0.85rem; color: #666; margin-top: 4px;">
                  <span *ngIf="isAdmin">Admin bắt buộc phải chọn chi nhánh.</span>
                  <span *ngIf="!isAdmin">Manager có thể bỏ trống, hệ thống sẽ tự động lấy chi nhánh của bạn.</span>
                </div>
              </ng-container>
            </ng-container>
            <ng-template #noBranches>
              <input name="branchId" [(ngModel)]="model.branchId" placeholder="Nhập Branch ID (UUID)" [required]="isAdmin" />
              <div class="hint" style="font-size: 0.85rem; color: #666; margin-top: 4px;">Không tải được danh sách chi nhánh. Vui lòng nhập UUID thủ công.</div>
            </ng-template>
          </label>
        </div>

        <div class="form-actions">
          <button class="btn primary" type="submit" [disabled]="saving">{{ saving ? 'Đang lưu...' : 'Lưu' }}</button>
          <button class="btn" type="button" (click)="router.navigate(['/admin/fields'])">Hủy</button>
        </div>
      </form>

      <div *ngIf="loading" class="loading">Đang tải...</div>
    </div>
  </section>
</div>