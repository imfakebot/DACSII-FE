<div class="admin-feedbacks-container">
  <div class="page-header">
    <h1>Quản lý Phản hồi khách hàng</h1>
    <p class="subtitle">Xem và trả lời các phản hồi từ người dùng</p>
  </div>

  <!-- Filters Section -->
  <div class="filters-section">
    <div class="filter-group">
      <label>Trạng thái:</label>
      <select [(ngModel)]="statusFilter" (change)="onStatusFilterChange()" class="filter-select">
        <option value="all">Tất cả</option>
        <option value="open">Mới</option>
        <option value="in_progress">Đang xử lý</option>
        <option value="resolved">Đã giải quyết</option>
        <option value="closed">Đã đóng</option>
      </select>
    </div>

    <div class="search-group">
      <input 
        type="text" 
        [(ngModel)]="searchQuery" 
        (input)="onSearchChange()"
        placeholder="Tìm kiếm theo tiêu đề, nội dung, tên người dùng..."
        class="search-input"
      />
    </div>
  </div>

  <!-- Stats Summary -->
  <div class="stats-summary" *ngIf="!loading">
    <div class="stat-card">
      <span class="stat-label">Tổng số</span>
      <span class="stat-value">{{ feedbacks.length }}</span>
    </div>
    <div class="stat-card">
      <span class="stat-label">Đang hiển thị</span>
      <span class="stat-value">{{ filteredFeedbacks.length }}</span>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading" class="loading-container">
    <div class="spinner"></div>
    <p>Đang tải danh sách phản hồi...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="error && !loading" class="error-alert">
    <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
      <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
      <path d="M7.002 11a1 1 0 1 1 2 0 1 1 0 0 1-2 0zM7.1 4.995a.905.905 0 1 1 1.8 0l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 4.995z"/>
    </svg>
    {{ error }}
  </div>

  <!-- Feedback List -->
  <div *ngIf="!loading && filteredFeedbacks.length > 0" class="feedbacks-list">
    <div *ngFor="let feedback of filteredFeedbacks" class="feedback-card">
      <div class="feedback-header">
      <div class="feedback-title-section">
        <h3 class="feedback-title">{{ feedback.title || feedback.subject || 'Phản hồi' }}</h3>
        <span class="status-badge" [ngClass]="getStatusClass(feedback.status)">
            {{ getStatusLabel(feedback.status) }}
          </span>
          <span *ngIf="hasUnreadResponses(feedback)" class="unread-badge">Mới</span>
        </div>
        <button class="view-detail-btn" (click)="viewDetail(feedback.id)">
          <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
            <path d="M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8zM1.173 8a13.133 13.133 0 0 1 1.66-2.043C4.12 4.668 5.88 3.5 8 3.5c2.12 0 3.879 1.168 5.168 2.457A13.133 13.133 0 0 1 14.828 8c-.058.087-.122.183-.195.288-.335.48-.83 1.12-1.465 1.755C11.879 11.332 10.119 12.5 8 12.5c-2.12 0-3.879-1.168-5.168-2.457A13.134 13.134 0 0 1 1.172 8z"/>
            <path d="M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5zM4.5 8a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0z"/>
          </svg>
          Chi tiết
        </button>
      </div>

      <div class="feedback-meta">
        <div class="meta-item">
          <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
            <path d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm2-3a2 2 0 1 1-4 0 2 2 0 0 1 4 0zm4 8c0 1-1 1-1 1H3s-1 0-1-1 1-4 6-4 6 3 6 4zm-1-.004c-.001-.246-.154-.986-.832-1.664C11.516 10.68 10.289 10 8 10c-2.29 0-3.516.68-4.168 1.332-.678.678-.83 1.418-.832 1.664h10z"/>
          </svg>
          <span>{{ feedback.user?.full_name || feedback.submitter?.full_name || 'Người dùng' }}</span>
        </div>
        <div class="meta-item">
          <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
            <path d="M0 4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V4Zm2-1a1 1 0 0 0-1 1v.217l7 4.2 7-4.2V4a1 1 0 0 0-1-1H2Zm13 2.383-4.708 2.825L15 11.105V5.383Zm-.034 6.876-5.64-3.471L8 9.583l-1.326-.795-5.64 3.47A1 1 0 0 0 2 13h12a1 1 0 0 0 .966-.741ZM1 11.105l4.708-2.897L1 5.383v5.722Z"/>
          </svg>
          <span>{{ feedback.user?.email || feedback.submitter?.email || '-' }}</span>
        </div>
        <div class="meta-item">
          <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
            <path d="M8 3.5a.5.5 0 0 0-1 0V9a.5.5 0 0 0 .252.434l3.5 2a.5.5 0 0 0 .496-.868L8 8.71V3.5z"/>
            <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm7-8A7 7 0 1 1 1 8a7 7 0 0 1 14 0z"/>
          </svg>
          <span>{{ getRelativeTime(feedback.created_at) }}</span>
        </div>
        <div class="meta-item" *ngIf="getResponseCount(feedback) > 0">
          <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
            <path d="M2.678 11.894a1 1 0 0 1 .287.801 10.97 10.97 0 0 1-.398 2c1.395-.323 2.247-.697 2.634-.893a1 1 0 0 1 .71-.074A8.06 8.06 0 0 0 8 14c3.996 0 7-2.807 7-6 0-3.192-3.004-6-7-6S1 4.808 1 8c0 1.468.617 2.83 1.678 3.894zm-.493 3.905a21.682 21.682 0 0 1-.713.129c-.2.032-.352-.176-.273-.362a9.68 9.68 0 0 0 .244-.637l.003-.01c.248-.72.45-1.548.524-2.319C.743 11.37 0 9.76 0 8c0-3.866 3.582-7 8-7s8 3.134 8 7-3.582 7-8 7a9.06 9.06 0 0 1-2.347-.306c-.52.263-1.639.742-3.468 1.105z"/>
          </svg>
          <span>{{ getResponseCount(feedback) }} phản hồi</span>
        </div>
      </div>

      <div class="feedback-message">
        Nhấn "Chi tiết" để xem nội dung phản hồi
      </div>

      <div class="feedback-actions">
        <button 
          class="action-btn quick-reply-btn"
          (click)="toggleQuickReply(feedback.id)"
          [class.active]="replyingToId === feedback.id"
        >
          <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
            <path d="M5.921 11.9 1.353 8.62a.719.719 0 0 1 0-1.238L5.921 4.1A.716.716 0 0 1 7 4.719V6c1.5 0 6 0 7 8-2.5-4.5-7-4-7-4v1.281c0 .56-.606.898-1.079.62z"/>
          </svg>
          {{ replyingToId === feedback.id ? 'Hủy' : 'Trả lời nhanh' }}
        </button>
      </div>

      <!-- Quick Reply Form -->
      <div *ngIf="replyingToId === feedback.id" class="quick-reply-form">
        <textarea 
          [(ngModel)]="replyMessage"
          placeholder="Nhập nội dung trả lời..."
          rows="3"
          class="reply-textarea"
        ></textarea>
        
        <div *ngIf="replyError" class="reply-error">{{ replyError }}</div>
        <div *ngIf="replySuccess" class="reply-success">{{ replySuccess }}</div>
        
        <div class="reply-actions">
          <button 
            class="submit-reply-btn"
            (click)="submitQuickReply(feedback.id)"
            [disabled]="replyLoading || !replyMessage.trim()"
          >
            <span *ngIf="!replyLoading">Gửi phản hồi</span>
            <span *ngIf="replyLoading">Đang gửi...</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Empty State -->
  <div *ngIf="!loading && filteredFeedbacks.length === 0 && feedbacks.length > 0" class="empty-state">
    <svg width="64" height="64" fill="currentColor" viewBox="0 0 16 16">
      <path d="M6 10.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 0 1h-3a.5.5 0 0 1-.5-.5zm-2-3a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5zm-2-3a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11a.5.5 0 0 1-.5-.5z"/>
    </svg>
    <h3>Không tìm thấy phản hồi</h3>
    <p>Không có phản hồi nào phù hợp với bộ lọc của bạn</p>
  </div>

  <div *ngIf="!loading && feedbacks.length === 0" class="empty-state">
    <svg width="64" height="64" fill="currentColor" viewBox="0 0 16 16">
      <path d="M14 1a1 1 0 0 1 1 1v8a1 1 0 0 1-1 1H4.414A2 2 0 0 0 3 11.586l-2 2V2a1 1 0 0 1 1-1h12zM2 0a2 2 0 0 0-2 2v12.793a.5.5 0 0 0 .854.353l2.853-2.853A1 1 0 0 1 4.414 12H14a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H2z"/>
    </svg>
    <h3>Chưa có phản hồi</h3>
    <p>Hiện tại chưa có phản hồi nào từ người dùng</p>
  </div>
</div>
