<div class="admin-branches-container">
  <header class="page-header">
    <div class="header-content">
      <div class="header-title">
        <h1>üèóÔ∏è Qu·∫£n l√Ω Chi nh√°nh</h1>
        <p class="subtitle">Qu·∫£n l√Ω v√† theo d√µi t·∫•t c·∫£ chi nh√°nh trong h·ªá th·ªëng</p>
      </div>
      <div class="header-actions">
        <button type="button" class="btn btn-refresh" (click)="loadBranches()" [disabled]="loading">
          <span class="icon">‚Üª</span> T·∫£i l·∫°i
        </button>
        <button type="button" class="btn btn-primary" (click)="openCreateForm()">
          <span class="icon">+</span> T·∫°o chi nh√°nh
        </button>
      </div>
    </div>
  </header>

  <!-- Stats Cards -->
  <div class="stats-grid">
    <div class="stat-card stat-card--blue">
      <div class="stat-icon">üèóÔ∏è</div>
      <div class="stat-content">
        <div class="stat-value">{{ branches.length }}</div>
        <div class="stat-label">T·ªïng chi nh√°nh</div>
      </div>
    </div>
    <div class="stat-card stat-card--green">
      <div class="stat-icon">‚öΩ</div>
      <div class="stat-content">
        <div class="stat-value">{{ getTotalFields() }}</div>
        <div class="stat-label">T·ªïng s·ªë s√¢n</div>
      </div>
    </div>
    <div class="stat-card stat-card--orange">
      <div class="stat-icon">üë•</div>
      <div class="stat-content">
        <div class="stat-value">{{ getManagerCount() }}</div>
        <div class="stat-label">Qu·∫£n l√Ω ƒë∆∞·ª£c g√°n</div>
      </div>
    </div>
    <div class="stat-card stat-card--purple">
      <div class="stat-icon">üìç</div>
      <div class="stat-content">
        <div class="stat-value">{{ getCityCount() }}</div>
        <div class="stat-label">Th√†nh ph·ªë</div>
      </div>
    </div>
  </div>

  <div *ngIf="error" class="alert alert-error">‚ö†Ô∏è {{ error }}</div>
  <div *ngIf="success" class="alert alert-success">‚úÖ {{ success }}</div>

  <div *ngIf="loading && !showForm" class="loading-state">‚è≥ ƒêang t·∫£i d·ªØ li·ªáu...</div>

  <div *ngIf="!loading && branches.length === 0" class="empty-state">
    üèõÔ∏è Ch∆∞a c√≥ chi nh√°nh n√†o. H√£y t·∫°o chi nh√°nh m·ªõi!
  </div>

  <div *ngIf="!loading && branches.length > 0" class="branches-grid">
    <div *ngFor="let branch of branches" class="branch-card">
      <div class="branch-card-header">
        <div class="branch-icon">üèóÔ∏è</div>
        <div class="branch-header-content">
          <h3 class="branch-name">{{ branch.name }}</h3>
          <span class="branch-badge">
            <span class="badge-dot"></span>
            Ho·∫°t ƒë·ªông
          </span>
        </div>
      </div>
      
      <div class="branch-card-body">
        <div class="info-grid">
          <div class="info-item">
            <div class="info-icon">üìû</div>
            <div class="info-content">
              <div class="info-label">ƒêi·ªán tho·∫°i</div>
              <div class="info-value">{{ branch.phoneNumber || branch.phone_number || 'Ch∆∞a c·∫≠p nh·∫≠t' }}</div>
            </div>
          </div>
          
          <div class="info-item">
            <div class="info-icon">üìç</div>
            <div class="info-content">
              <div class="info-label">ƒê·ªãa ch·ªâ</div>
              <div class="info-value">{{ branch.address?.street || 'Ch∆∞a c·∫≠p nh·∫≠t' }}, {{ getCityName(branch.address?.cityId) }}</div>
            </div>
          </div>
          
          <div class="info-item">
            <div class="info-icon">üë§</div>
            <div class="info-content">
              <div class="info-label">Qu·∫£n l√Ω</div>
              <div class="info-value">{{ branch.manager?.fullName || 'Ch∆∞a g√°n' }}</div>
            </div>
          </div>
          
          <div class="info-item">
            <div class="info-icon">‚öΩ</div>
            <div class="info-content">
              <div class="info-label">S·ªë s√¢n</div>
              <div class="info-value">{{ (branch.fields && branch.fields.length) || 0 }} s√¢n</div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="branch-card-footer">
        <button type="button" class="btn-card btn-card--edit" (click)="openEditForm(branch)" title="Ch·ªânh s·ª≠a">
          <span class="icon">‚úèÔ∏è</span> Ch·ªânh s·ª≠a
        </button>
        <button type="button" class="btn-card btn-card--delete" (click)="deleteBranch(branch)" title="X√≥a">
          <span class="icon">üóëÔ∏è</span> X√≥a
        </button>
      </div>
    </div>
  </div>

  <!-- Form Modal -->
  <div *ngIf="showForm" class="modal-overlay" (click)="closeForm()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>{{ editMode ? 'Ch·ªânh s·ª≠a chi nh√°nh' : 'T·∫°o chi nh√°nh m·ªõi' }}</h2>
        <button type="button" class="btn-close" (click)="closeForm()">√ó</button>
      </div>

      <div *ngIf="error" class="alert alert-error">{{ error }}</div>

      <form class="modal-body" (ngSubmit)="submitForm()">
        <label class="field">
          <span>T√™n chi nh√°nh <span class="required">*</span></span>
          <input type="text" name="name" [(ngModel)]="form.name" placeholder="VD: Chi nh√°nh Qu·∫≠n 1" required />
        </label>

        <label class="field">
          <span>S·ªë ƒëi·ªán tho·∫°i <span class="required">*</span></span>
          <input type="tel" name="phoneNumber" [(ngModel)]="form.phoneNumber" placeholder="0912345678" required />
        </label>

        <div class="field-row">
          <label class="field">
            <span>Gi·ªù m·ªü c·ª≠a <span class="required">*</span></span>
            <input type="time" step="1" name="openTime" [(ngModel)]="form.openTime" required />
          </label>
          <label class="field">
            <span>Gi·ªù ƒë√≥ng c·ª≠a <span class="required">*</span></span>
            <input type="time" step="1" name="closeTime" [(ngModel)]="form.closeTime" required />
          </label>
        </div>

        <label class="field">
          <span>Qu·∫£n l√Ω</span>
          <select name="managerId" [(ngModel)]="form.managerId">
            <option [ngValue]="undefined">-- Ch∆∞a g√°n qu·∫£n l√Ω --</option>
            <option *ngFor="let mgr of availableManagers" [ngValue]="mgr.id">{{ mgr.fullName }} ({{ mgr.phoneNumber }})</option>
            <option *ngIf="currentBranch?.manager" [ngValue]="currentBranch?.managerId">{{ currentBranch?.manager?.fullName }} ({{ currentBranch?.manager?.phoneNumber }}) - Hi·ªán t·∫°i</option>
          </select>
        </label>

        <label class="field">
          <span>T·ªânh/Th√†nh ph·ªë <span class="required">*</span></span>
          <select name="cityId" [(ngModel)]="form.cityId" (change)="onCityChange()" required>
            <option value="">-- Ch·ªçn T·ªânh/Th√†nh --</option>
            <option *ngFor="let city of cities" [value]="city.id">{{ city.name }}</option>
          </select>
        </label>

        <label class="field">
          <span>Qu·∫≠n/Huy·ªán <span class="required">*</span></span>
          <select name="wardId" [(ngModel)]="form.wardId" required [disabled]="!form.cityId || wards.length === 0">
            <option value="">-- Ch·ªçn Qu·∫≠n/Huy·ªán --</option>
            <option *ngFor="let ward of wards" [value]="ward.id">{{ ward.name }}</option>
          </select>
        </label>

        <label class="field">
          <span>ƒê·ªãa ch·ªâ (S·ªë nh√†, t√™n ƒë∆∞·ªùng)</span>
          <input type="text" name="street" [(ngModel)]="form.street" placeholder="VD: 123 Nguy·ªÖn Hu·ªá" />
        </label>

        <div class="field-row">
          <label class="field">
            <span>Vƒ© ƒë·ªô (Latitude)</span>
            <input type="number" step="any" name="latitude" [(ngModel)]="form.latitude" placeholder="10.7769" />
          </label>
          <label class="field">
            <span>Kinh ƒë·ªô (Longitude)</span>
            <input type="number" step="any" name="longitude" [(ngModel)]="form.longitude" placeholder="106.7009" />
          </label>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn secondary" (click)="closeForm()">H·ªßy</button>
          <button type="submit" class="btn primary" [disabled]="loading">
            {{ loading ? 'ƒêang l∆∞u...' : (editMode ? 'C·∫≠p nh·∫≠t' : 'T·∫°o m·ªõi') }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
